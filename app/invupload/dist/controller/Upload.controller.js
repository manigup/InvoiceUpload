sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/BusyIndicator","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox"],function(e,t,i,o,s,r,a){"use strict";return e.extend("sap.fiori.invupload.controller.Upload",{onInit:function(){this.tblTemp=this.byId("uploadTblTemp").clone();this.getView().setModel(new t,"DataModel");this.getView().setModel(new t({}),"EditModel");this.getView().setModel(new t({}),"DecisionModel");this.getView().setModel(new t([]),"AttachmentModel");this.getView().setModel(new t([]),"HistoryModel");this.getView().setModel(new t([]),"UnitCodeModel");this.getView().setModel(new t([]),"FinModel");this.getView().setModel(new t({}),"Filter")},onAfterRendering:function(){this.getData();const e=JSON.parse(sessionStorage.getItem("CodeDetails"))||[{code:"P39"}];this.getView().setModel(new t(e),"CodeDetails");this.getView().getModel().read("/FinanceDetails",{success:e=>{this.getView().getModel("FinModel").setData(e.results);this.getView().getModel("FinModel").refresh(true)}});if(this.getView().getModel().getHeaders().loginType==="P"){this.getView().getModel().read("/PlantDetails",{success:e=>{this.getView().getModel("UnitCodeModel").setData(e.results);this.getView().getModel("UnitCodeModel").refresh(true)}})}},getData:function(){const e=this.getView().getModel("Filter").getData();let t=[];Object.keys(e).forEach(i=>{if(!jQuery.isEmptyObject(e[i])){t.push(new s(i,"EQ",e[i]))}});this.byId("uploadTbl").bindAggregation("items",{path:"/Invoice",filters:t,template:this.tblTemp})},onFilterClear:function(){this.getView().getModel("Filter").setData({});this.getView().getModel("Filter").refresh(true)},onAddPress:function(){const e=sap.ui.xmlfragment("sap.fiori.invupload.fragment.Create",this);this.getView().addDependent(e);this.getView().getModel("DataModel").setData({});this.getView().getModel("DataModel").refresh(true);sap.ui.getCore().byId("attachment").setUploadUrl(this.getView().getModel().sServiceUrl+"/Attachments");e.open()},onInvNoPress:function(e){const t=e.getSource().getBindingContext().getObject();const i=sap.ui.xmlfragment("sap.fiori.invupload.fragment.Edit",this);this.getView().addDependent(i);this.getView().getModel("EditModel").setData(t);this.getView().getModel("EditModel").refresh(true);this.invNo=t.InvoiceNumber;this.id=t.Id;this.getAttachments();sap.ui.getCore().byId("attachment").setUploadUrl(this.getView().getModel().sServiceUrl+"/Attachments");i.open()},getAttachments:function(){this.getView().getModel().read("/Attachments",{filters:[new s("Id","EQ",this.id)],success:e=>{this.getView().getModel("AttachmentModel").setData(e.results);this.getView().getModel("AttachmentModel").refresh(true);i.hide()},error:()=>i.hide()})},onCreatePress:function(e){this.dialogSource=e.getSource();const t=this.getView().getModel("DataModel").getData();let o=["invDate","invNo","invAmmount","gst","pCode","invType","reason","L1Approver","finApprover"];if(t.InvoiceType==="Domestic Service Procurement"){o.push("service");o.push("serviceGroup");o.push("dept");o.push("L2Approver");o.push("L3Approver")}if(this.validateReqFields(o)&&sap.ui.getCore().byId("attachment").getIncompleteItems().length>0){i.show();setTimeout(()=>{this.getView().getModel().create("/Invoice",t,{success:e=>{this.toEmail=e.L1HodApprover.split("/");this.invNo=e.InvoiceNumber;this.id=e.Id;this.doAttachment()},error:()=>i.hide()})},500)}else{a.error("Please fill all required inputs to proceed")}},onEditPress:function(e){this.dialogSource=e.getSource();let t=this.getView().getModel("EditModel").getData(),o=["invDate","invNo","invAmmount","gst","pCode","invType","reason","L1Approver","finApprover"];t.Action="E";if(t.InvoiceType==="Domestic Service Procurement"){o.push("service");o.push("serviceGroup");o.push("dept");o.push("L2Approver");o.push("L3Approver")}if(this.validateReqFields(o)){i.show();setTimeout(()=>{this.getView().getModel().update("/Invoice(InvoiceNumber='"+this.invNo+"',Id='"+this.id+"')",t,{success:e=>{i.hide();a.success("Invoice "+e.InvoiceNumber+" updated successfully",{onClose:()=>{const e=t.L1HodApprover.split("/"),i="Invoice number "+this.invNo+" updated by supplier "+sap.ui.getCore().userName+".";e.forEach(e=>{this.toAddress=e;this.sendEmailNotification(i)});this.dialogSource.getParent().destroy();this.getData()}})},error:()=>i.hide()})},500)}else{a.error("Please fill all required inputs to proceed")}},onAction:function(e,t){const i=e.getSource(),o=i.getBindingContext().getObject();this.invNo=o.InvoiceNumber;this.id=o.Id;this.cStatus=o.Status;this.createdBy=o.createdBy;this.getView().getModel("DecisionModel").setData({Action:t});if(o.Status==="ABP"){this.plantCode=o.PlantCode;this.finApprover=o.FinanceApprover;this.openFinFrag()}else{this.openHodFrag()}},openHodFrag:function(){const e=sap.ui.xmlfragment("sap.fiori.invupload.fragment.HodRemarks",this);this.getView().addDependent(e);e.open()},openFinFrag:function(){const e=sap.ui.xmlfragment("sap.fiori.invupload.fragment.FinAction",this);this.getView().addDependent(e);e.open()},onHodSubmit:function(e){this.dialogSource=e.getSource();const t=this.getView().getModel("DecisionModel").getData();if(this.validateReqFields(["remarks"])){let e={};if(this.cStatus==="PL1"){e.L1HodRemarks=t.HodRemarks;e.L1HodApproverName=sap.ui.getCore().userName}else if(this.cStatus==="PL2"){e.L2HodRemarks=t.HodRemarks;e.L2HodApproverName=sap.ui.getCore().userName}else if(this.cStatus==="PL3"){e.L3HodRemarks=t.HodRemarks;e.L3HodApproverName=sap.ui.getCore().userName}e.Action=t.Action;e.Status=this.cStatus;e.InvoiceNumber=this.invNo;this.takeAction(e)}else{a.error("Please fill all required inputs to proceed")}},onFinSubmit:function(e){this.dialogSource=e.getSource();const t=this.getView().getModel("DecisionModel").getData(),i=t.Action==="A"?["postingDate","accNo","remarks"]:["remarks"];if(this.validateReqFields(i)){const e={PostingDate:t.PostingDate,AccountingNumber:t.AccountingNumber,FinRemarks:t.FinRemarks,FinApproverName:sap.ui.getCore().userName,Action:t.Action,Status:this.cStatus,InvoiceNumber:this.invNo,PlantCode:this.plantCode};this.takeAction(e)}else{a.error("Please fill all required inputs to proceed")}},takeAction:function(e){setTimeout(()=>{this.getView().getModel().update("/Invoice(Id='"+this.id+"',InvoiceNumber='"+this.invNo+"')",e,{success:()=>{i.hide();a.success("Action taken successfully",{onClose:t=>{let i=e.Action==="A"?" approved ":" rejected ";if(e.Status==="ABP"){i+=" by finance "}else{i+=" by purchase "}if(t.Status==="ABP"){this.finApprover.split("/").forEach(e=>{this.toAddress=e;this.sendEmailNotification("Invoice number "+this.invNo+i+sap.ui.getCore().userName+".")})}else if(e.Action==="R"){this.toAddress=this.createdBy;this.sendEmailNotification("Invoice number "+this.invNo+i+".")}else{this.toAddress=sap.ui.getCore().loginEmail;this.sendEmailNotification("Invoice number "+this.invNo+i+sap.ui.getCore().userName+".")}this.dialogSource.getParent().destroy();this.getData()}})},error:()=>i.hide()})},500)},validateReqFields:function(e){let t=[],i,o;e.forEach(e=>{i=sap.ui.getCore().byId(e);o=i.getMetadata().getName()==="sap.m.Select"?i.getSelectedKey():i.getValue();if(i.getVisible()===true&&o===""){i.setValueState("Error").setValueStateText("Required");t.push(false)}else{i.setValueState("None");t.push(true)}});if(t.every(e=>e===true))return true;else return false},doAttachment:function(){this.items=sap.ui.getCore().byId("attachment").getIncompleteItems();sap.ui.getCore().byId("attachment").uploadItem(this.items[0]);this.items.splice(0,1)},onAttachItemAdd:function(e){e.getParameter("item").setVisibleEdit(false).setVisibleRemove(false)},onBeforeUploadStarts:function(e){e.getParameter("item").addHeaderField(new sap.ui.core.Item({key:"slug",text:this.id+"/"+e.getParameter("item").getFileName()}))},onUploadComplete:function(){if(sap.ui.getCore().byId("attachment").getIncompleteItems().length===0){i.hide();a.success("Invoice "+this.invNo+" uploaded successfully",{onClose:()=>{const e="New invoice "+this.invNo+" uploaded by supplier "+sap.ui.getCore().userName+".";this.toEmail.forEach(t=>{this.toAddress=t;this.sendEmailNotification(e)});this.getView().getModel("DataModel").setData({});this.dialogSource.getParent().destroy();this.getData()}})}else{sap.ui.getCore().byId("attachment").uploadItem(this.items[0]);this.items.splice(0,1)}},onAttachmentUploadComplete:function(){if(sap.ui.getCore().byId("attachment").getIncompleteItems().length>0){sap.ui.getCore().byId("attachment").uploadItem(this.items[0]);this.items.splice(0,1)}},onAttachmentPress:function(e){i.show();const o=e.getSource(),r=o.getBindingContext().getProperty("Id");setTimeout(()=>{this.getView().getModel().read("/Attachments",{filters:[new s("Id","EQ",r)],success:e=>{e.results.map(e=>e.Url=this.getView().getModel().sServiceUrl+"/Attachments(Id='"+e.Id+"',ObjectId='"+e.ObjectId+"')/$value");var s=sap.ui.xmlfragment("sap.fiori.invupload.fragment.Attachment",this);sap.ui.getCore().byId("attachPopover").setModel(new t(e),"AttachModel");this.getView().addDependent(s);s.openBy(o);i.hide()},error:()=>i.hide()})},1e3)},onDialogClose:function(e){e.getSource().destroy()},onDialogCancel:function(e){e.getSource().getParent().destroy()},onPopOverClosePress:function(e){e.getSource().getParent().getParent().destroy()},setHodApprover:function(e,t){const i=e.getSource().getSelectedItem().getBindingContext().getObject();if(t==="C"){this.getView().getModel("DataModel").getData().L1HodApprover=i.Email;this.getView().getModel("DataModel").getData().L1HodApproverName=i.Name;this.getView().getModel("DataModel").refresh(true)}else{this.getView().getModel("EditModel").getData().L1HodApprover=i.Email;this.getView().getModel("EditModel").getData().L1HodApproverName=i.Name;this.getView().getModel("EditModel").refresh(true)}},sendEmailNotification:function(e){const t=window.location.origin+"/site/SP#invupload-manage?sap-ui-app-id-hint=saas_approuter_sap.fiori.invupload";return new Promise((i,o)=>{const s=`|| ${e} Kindly log-in with the link to take your action.<br><br><a href='${t}'>CLICK HERE</a>`,r=this.getView().getModel(),a={method:"GET",urlParameters:{content:s,toAddress:this.toAddress},success:function(e){console.log("Email sent successfully.");i(e)},error:function(e){console.log("Failed to send email.");o(e)}};r.callFunction("/sendEmail",a)})},onValueHelpRequest:function(){var e=this.getView();if(!this._pValueHelpDialog){this._pValueHelpDialog=o.load({id:e.getId(),name:"sap.fiori.invupload.fragment.ValueHelp",controller:this}).then(function(t){e.addDependent(t);return t})}this._pValueHelpDialog.then(function(e){e.open()})},onValueHelpSearch:function(e){var t=e.getParameter("value");var i=new s("SERVICE",r.Contains,t);e.getSource().getBinding("items").filter([i])},onValueHelpClose:function(e){var t=e.getParameter("selectedItem").getBindingContext().getObject();e.getSource().getBinding("items").filter([]);if(!t){return}sap.ui.getCore().byId("service").setValue(t.SERVICE);sap.ui.getCore().byId("serviceGroup").setValue(t.SERVICE_GROUP);sap.ui.getCore().byId("dept").setValue(t.SERVICE_CATEGORY);let i=this.getView().getModel("DataModel").getData(),o=this.getView().getModel("UnitCodeModel").getData().filter(e=>e.Unit_Code===i.PlantCode)[0];if(t.Approver1==="Division Head"){i.L1HodApprover=o.Email_Division_Head;i.L1HodApproverName=o.Division_Head}else if(t.Approver1==="Plant Head"){i.L1HodApprover=o.Email_Plant_Head;i.L1HodApproverName=o.Plant_Head}else{i.L1HodApprover=t.Approver1_Email;i.L1HodApproverName=t.Approver1}if(t.Approver2!=="N/A"&&parseInt(i.TotalInvoiceAmount)>=2e5){i.L2HodApprover=t.Approver2_Email;i.L2HodApproverName=t.Approver2}else if(t.Approver2==="N/A"||parseInt(i.TotalInvoiceAmount)<2e5){delete i.L2HodApprover;delete i.L2HodApproverName}if(t.Approver3!=="N/A"&&parseInt(i.TotalInvoiceAmount)>2e6){i.L3HodApprover=t.Approver3_Email;i.L3HodApproverName=t.Approver3}else if(t.Approver3==="N/A"||parseInt(i.TotalInvoiceAmount)<2e6){delete i.L3HodApprover;delete i.L3HodApproverName}this.getView().getModel("DataModel").refresh(true)},onApproverDetailsPress:function(e){const t=e.getSource().getBindingContext().getObject();let i=[];for(var s=1;s<=3;s++){if(t["L"+s+"ApprovedAt"]){i.push({Level:"Purchase Level "+s,Approver:t["L"+s+"HodApproverName"],ApproverEmail:t["L"+s+"HodApprover"],ApprovedAt:t["L"+s+"ApprovedAt"],Remarks:t["L"+s+"HodRemarks"]})}}if(t.FinApprovedAt){i.push({Level:"Finance",Approver:t.FinApproverName,ApproverEmail:t.FinanceApprover,ApprovedAt:t.FinApprovedAt,Remarks:t.FinRemarks})}this.getView().getModel("HistoryModel").setData(i);this.getView().getModel("HistoryModel").refresh(true);var r=e.getSource(),a=this.getView();if(!this._pPopover){this._pPopover=o.load({id:a.getId(),name:"sap.fiori.invupload.fragment.ApprovalHistory",controller:this}).then(function(e){a.addDependent(e);return e})}this._pPopover.then(function(e){e.openBy(r)})},onPlantChange:function(e){const t=e.getParameter("selectedItem").getBindingContext("CodeDetails").getProperty("code"),i=this.getView().getModel("FinModel").getData(),o=i.filter(e=>e.Plant===t);if(o.length>0){sap.ui.getCore().byId("finApprover").setValue(o[0].Email)}else{sap.ui.getCore().byId("finApprover").setValue("")}}})});